#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include "test.h"
#include "util.h"
#include "message.h"
#include "message_dbus.h"

static MessageConnection *init ()
{
    char buf[] = "/tagfs/test/XXXXXXXXXX";
    int i;
    for (i = strlen(buf) - 1; buf[i] == 'X'; i--);
    snprintf(buf+i, strlen(buf), "%d", getpid());
    return dbus_init(buf);
}

%(test message_dbus test_max_signal_alloc)
{
    /* Test that message_system_prepare_signal fails when the maximum number of
       messages has been sent */
    MessageConnection *mconn = init();
    int nmessages = 0;
    while ( mconn->sys->prepare_signal(mconn, "signal") >= 0)
        nmessages++;
    mconn->sys->destroy(mconn);
    CU_ASSERT_EQUAL(MESSAGE_POOL_SIZE, nmessages);
}

int main ()
{
   %(run_tests);
}


